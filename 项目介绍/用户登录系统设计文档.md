# ç”¨æˆ·ç™»å½•ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## ä¸€ã€ç³»ç»Ÿæ¦‚è¿°

### 1.1 åŠŸèƒ½ç›®æ ‡
ä¸ºç½‘çƒç¤¾äº¤å¹³å°æä¾›å®‰å…¨ã€ä¾¿æ·çš„ç”¨æˆ·èº«ä»½è®¤è¯ç³»ç»Ÿï¼Œæ”¯æŒç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€å¯†ç æ‰¾å›ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### 1.2 æŠ€æœ¯æ ˆ
- **å‰ç«¯ï¼š** React Native + TypeScript
- **åç«¯ï¼š** FastAPI + Python
- **æ•°æ®åº“ï¼š** PostgreSQL
- **è®¤è¯æ–¹å¼ï¼š** JWT (JSON Web Token)
- **å¯†ç åŠ å¯†ï¼š** Bcrypt
- **å­˜å‚¨ï¼š** AsyncStorage (å‰ç«¯) + Redis (åç«¯ï¼Œå¯é€‰)

---

## äºŒã€åŠŸèƒ½éœ€æ±‚

### 2.1 æ ¸å¿ƒåŠŸèƒ½åˆ—è¡¨

#### âœ… å¿…éœ€åŠŸèƒ½ï¼ˆMVPï¼‰
1. **ç”¨æˆ·æ³¨å†Œ**
   - é‚®ç®±æ³¨å†Œ
   - æ‰‹æœºå·æ³¨å†Œ
   - å¯†ç å¼ºåº¦éªŒè¯
   - ç”¨æˆ·åå”¯ä¸€æ€§æ£€æŸ¥

2. **ç”¨æˆ·ç™»å½•**
   - é‚®ç®±/ç”¨æˆ·åç™»å½•
   - æ‰‹æœºå·ç™»å½•
   - å¯†ç éªŒè¯
   - è®°ä½ç™»å½•çŠ¶æ€

3. **å¯†ç ç®¡ç†**
   - å¿˜è®°å¯†ç 
   - é‚®ç®±/çŸ­ä¿¡éªŒè¯ç 
   - é‡ç½®å¯†ç 

4. **Token ç®¡ç†**
   - JWT Token ç”Ÿæˆ
   - Token åˆ·æ–°æœºåˆ¶
   - Token è¿‡æœŸå¤„ç†
   - è‡ªåŠ¨ç™»å‡º

#### ğŸ”„ æ‰©å±•åŠŸèƒ½ï¼ˆV2ï¼‰
5. **ç¬¬ä¸‰æ–¹ç™»å½•**
   - å¾®ä¿¡ç™»å½•
   - QQ ç™»å½•
   - Apple ID ç™»å½•

6. **å®‰å…¨åŠŸèƒ½**
   - åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰
   - ç™»å½•è®¾å¤‡ç®¡ç†
   - å¼‚å¸¸ç™»å½•æé†’
   - ç™»å½•æ—¥å¿—

---

## ä¸‰ã€æ•°æ®åº“è®¾è®¡

### 3.1 ç”¨æˆ·è¡¨ï¼ˆusersï¼‰

```sql
CREATE TABLE users (
    -- åŸºç¡€ä¿¡æ¯
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    phone VARCHAR(20) UNIQUE,
    hashed_password VARCHAR(255) NOT NULL,
    
    -- ä¸ªäººèµ„æ–™
    avatar VARCHAR(500),
    nickname VARCHAR(100),
    bio TEXT,
    gender VARCHAR(10),
    birth_date DATE,
    
    -- ç½‘çƒç›¸å…³
    skill_level VARCHAR(20) DEFAULT 'beginner',
    -- 'beginner', 'intermediate', 'advanced', 'professional'
    play_style VARCHAR(50),
    favorite_court VARCHAR(255),
    
    -- è´¦æˆ·çŠ¶æ€
    is_active BOOLEAN DEFAULT TRUE,
    is_verified BOOLEAN DEFAULT FALSE,
    is_premium BOOLEAN DEFAULT FALSE,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP WITH TIME ZONE,
    
    -- ç´¢å¼•
    CONSTRAINT users_username_check CHECK (char_length(username) >= 3),
    CONSTRAINT users_email_check CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_created_at ON users(created_at);
```

### 3.2 éªŒè¯ç è¡¨ï¼ˆverification_codesï¼‰

```sql
CREATE TABLE verification_codes (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    email VARCHAR(255),
    phone VARCHAR(20),
    code VARCHAR(6) NOT NULL,
    code_type VARCHAR(20) NOT NULL,
    -- 'email_verify', 'phone_verify', 'password_reset'
    is_used BOOLEAN DEFAULT FALSE,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT verification_codes_code_check CHECK (char_length(code) = 6)
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_verification_codes_email ON verification_codes(email);
CREATE INDEX idx_verification_codes_phone ON verification_codes(phone);
CREATE INDEX idx_verification_codes_expires_at ON verification_codes(expires_at);
```

### 3.3 ç™»å½•æ—¥å¿—è¡¨ï¼ˆlogin_logsï¼‰

```sql
CREATE TABLE login_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    login_method VARCHAR(20) NOT NULL,
    -- 'email', 'phone', 'username', 'wechat', 'qq'
    ip_address VARCHAR(45),
    device_info TEXT,
    user_agent TEXT,
    location VARCHAR(255),
    is_success BOOLEAN DEFAULT TRUE,
    failure_reason TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_login_logs_user_id ON login_logs(user_id);
CREATE INDEX idx_login_logs_created_at ON login_logs(created_at);
```

### 3.4 åˆ·æ–°ä»¤ç‰Œè¡¨ï¼ˆrefresh_tokensï¼‰

```sql
CREATE TABLE refresh_tokens (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    token VARCHAR(500) UNIQUE NOT NULL,
    device_id VARCHAR(255),
    device_name VARCHAR(255),
    is_revoked BOOLEAN DEFAULT FALSE,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_used_at TIMESTAMP WITH TIME ZONE
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_refresh_tokens_user_id ON refresh_tokens(user_id);
CREATE INDEX idx_refresh_tokens_token ON refresh_tokens(token);
CREATE INDEX idx_refresh_tokens_expires_at ON refresh_tokens(expires_at);
```

---

## å››ã€åç«¯ API è®¾è®¡

### 4.1 API æ¥å£åˆ—è¡¨

#### è®¤è¯ç›¸å…³ API

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| ç”¨æˆ·æ³¨å†Œ | POST | `/api/auth/register` | æ–°ç”¨æˆ·æ³¨å†Œ |
| ç”¨æˆ·ç™»å½• | POST | `/api/auth/login` | ç”¨æˆ·ç™»å½•è·å– Token |
| åˆ·æ–° Token | POST | `/api/auth/refresh` | åˆ·æ–°è®¿é—®ä»¤ç‰Œ |
| ç™»å‡º | POST | `/api/auth/logout` | ç”¨æˆ·ç™»å‡º |
| å‘é€éªŒè¯ç  | POST | `/api/auth/send-code` | å‘é€é‚®ç®±/çŸ­ä¿¡éªŒè¯ç  |
| éªŒè¯é‚®ç®± | POST | `/api/auth/verify-email` | éªŒè¯é‚®ç®±åœ°å€ |
| å¿˜è®°å¯†ç  | POST | `/api/auth/forgot-password` | è¯·æ±‚å¯†ç é‡ç½® |
| é‡ç½®å¯†ç  | POST | `/api/auth/reset-password` | é‡ç½®å¯†ç  |
| ä¿®æ”¹å¯†ç  | POST | `/api/auth/change-password` | ä¿®æ”¹å½“å‰å¯†ç  |
| è·å–å½“å‰ç”¨æˆ· | GET | `/api/auth/me` | è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ |
| æ£€æŸ¥ç”¨æˆ·å | GET | `/api/auth/check-username` | æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å¯ç”¨ |
| æ£€æŸ¥é‚®ç®± | GET | `/api/auth/check-email` | æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²æ³¨å†Œ |

### 4.2 æ•°æ®æ¨¡å‹ï¼ˆPydantic Schemasï¼‰

#### backend/app/schemas/user.py

```python
from pydantic import BaseModel, EmailStr, Field, validator
from typing import Optional
from datetime import datetime
from enum import Enum

class SkillLevel(str, Enum):
    BEGINNER = "beginner"
    INTERMEDIATE = "intermediate"
    ADVANCED = "advanced"
    PROFESSIONAL = "professional"

class Gender(str, Enum):
    MALE = "male"
    FEMALE = "female"
    OTHER = "other"

# ç”¨æˆ·æ³¨å†Œ
class UserRegister(BaseModel):
    username: str = Field(..., min_length=3, max_length=50)
    email: EmailStr
    phone: Optional[str] = Field(None, regex=r'^\+?1?\d{9,15}$')
    password: str = Field(..., min_length=8, max_length=100)
    nickname: Optional[str] = Field(None, max_length=100)
    
    @validator('username')
    def username_alphanumeric(cls, v):
        assert v.isalnum() or '_' in v, 'ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿'
        return v
    
    @validator('password')
    def password_strength(cls, v):
        if len(v) < 8:
            raise ValueError('å¯†ç é•¿åº¦è‡³å°‘ 8 ä½')
        if not any(char.isdigit() for char in v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«æ•°å­—')
        if not any(char.isalpha() for char in v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«å­—æ¯')
        return v

# ç”¨æˆ·ç™»å½•
class UserLogin(BaseModel):
    username_or_email: str  # å¯ä»¥æ˜¯ç”¨æˆ·åæˆ–é‚®ç®±
    password: str

# æ‰‹æœºå·ç™»å½•
class PhoneLogin(BaseModel):
    phone: str = Field(..., regex=r'^\+?1?\d{9,15}$')
    code: str = Field(..., min_length=6, max_length=6)

# Token å“åº”
class Token(BaseModel):
    access_token: str
    refresh_token: str
    token_type: str = "bearer"
    expires_in: int  # ç§’

# Token æ•°æ®
class TokenData(BaseModel):
    user_id: Optional[int] = None
    username: Optional[str] = None

# ç”¨æˆ·åŸºç¡€ä¿¡æ¯
class UserBase(BaseModel):
    username: str
    email: EmailStr
    phone: Optional[str]
    nickname: Optional[str]
    avatar: Optional[str]
    bio: Optional[str]
    gender: Optional[Gender]
    birth_date: Optional[datetime]
    skill_level: SkillLevel = SkillLevel.BEGINNER
    play_style: Optional[str]
    favorite_court: Optional[str]

# ç”¨æˆ·å“åº”ï¼ˆè¿”å›ç»™å‰ç«¯ï¼‰
class UserResponse(UserBase):
    id: int
    is_active: bool
    is_verified: bool
    is_premium: bool
    created_at: datetime
    last_login_at: Optional[datetime]
    
    class Config:
        from_attributes = True

# ç”¨æˆ·æ›´æ–°
class UserUpdate(BaseModel):
    nickname: Optional[str]
    avatar: Optional[str]
    bio: Optional[str]
    gender: Optional[Gender]
    birth_date: Optional[datetime]
    skill_level: Optional[SkillLevel]
    play_style: Optional[str]
    favorite_court: Optional[str]

# ä¿®æ”¹å¯†ç 
class PasswordChange(BaseModel):
    old_password: str
    new_password: str = Field(..., min_length=8, max_length=100)
    
    @validator('new_password')
    def password_strength(cls, v):
        if len(v) < 8:
            raise ValueError('å¯†ç é•¿åº¦è‡³å°‘ 8 ä½')
        if not any(char.isdigit() for char in v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«æ•°å­—')
        if not any(char.isalpha() for char in v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«å­—æ¯')
        return v

# é‡ç½®å¯†ç 
class PasswordReset(BaseModel):
    email: EmailStr
    code: str = Field(..., min_length=6, max_length=6)
    new_password: str = Field(..., min_length=8, max_length=100)

# å‘é€éªŒè¯ç 
class SendVerificationCode(BaseModel):
    email: Optional[EmailStr]
    phone: Optional[str]
    code_type: str  # 'email_verify', 'phone_verify', 'password_reset'

# éªŒè¯é‚®ç®±
class EmailVerification(BaseModel):
    email: EmailStr
    code: str = Field(..., min_length=6, max_length=6)
```

### 4.3 æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

#### backend/app/services/auth.py

```python
from sqlalchemy.orm import Session
from sqlalchemy import or_
from passlib.context import CryptContext
from jose import JWTError, jwt
from datetime import datetime, timedelta
from typing import Optional
import secrets
import string

from app.models.user import User
from app.models.verification_code import VerificationCode
from app.schemas.user import UserRegister, UserLogin, TokenData
from app.core.config import settings
from app.core.security import verify_password, get_password_hash

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

class AuthService:
    """è®¤è¯æœåŠ¡"""
    
    @staticmethod
    def create_user(db: Session, user_data: UserRegister) -> User:
        """åˆ›å»ºæ–°ç”¨æˆ·"""
        # æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        if db.query(User).filter(User.username == user_data.username).first():
            raise ValueError("ç”¨æˆ·åå·²å­˜åœ¨")
        
        # æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²æ³¨å†Œ
        if db.query(User).filter(User.email == user_data.email).first():
            raise ValueError("é‚®ç®±å·²è¢«æ³¨å†Œ")
        
        # æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²æ³¨å†Œ
        if user_data.phone:
            if db.query(User).filter(User.phone == user_data.phone).first():
                raise ValueError("æ‰‹æœºå·å·²è¢«æ³¨å†Œ")
        
        # åˆ›å»ºç”¨æˆ·
        db_user = User(
            username=user_data.username,
            email=user_data.email,
            phone=user_data.phone,
            hashed_password=get_password_hash(user_data.password),
            nickname=user_data.nickname or user_data.username,
        )
        
        db.add(db_user)
        db.commit()
        db.refresh(db_user)
        
        return db_user
    
    @staticmethod
    def authenticate_user(db: Session, username_or_email: str, password: str) -> Optional[User]:
        """éªŒè¯ç”¨æˆ·èº«ä»½"""
        # æ”¯æŒç”¨æˆ·åæˆ–é‚®ç®±ç™»å½•
        user = db.query(User).filter(
            or_(
                User.username == username_or_email,
                User.email == username_or_email
            )
        ).first()
        
        if not user:
            return None
        
        if not verify_password(password, user.hashed_password):
            return None
        
        if not user.is_active:
            raise ValueError("è´¦æˆ·å·²è¢«ç¦ç”¨")
        
        # æ›´æ–°æœ€åç™»å½•æ—¶é—´
        user.last_login_at = datetime.utcnow()
        db.commit()
        
        return user
    
    @staticmethod
    def create_access_token(data: dict, expires_delta: Optional[timedelta] = None) -> str:
        """åˆ›å»ºè®¿é—®ä»¤ç‰Œ"""
        to_encode = data.copy()
        
        if expires_delta:
            expire = datetime.utcnow() + expires_delta
        else:
            expire = datetime.utcnow() + timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
        
        to_encode.update({"exp": expire, "type": "access"})
        encoded_jwt = jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)
        
        return encoded_jwt
    
    @staticmethod
    def create_refresh_token(data: dict) -> str:
        """åˆ›å»ºåˆ·æ–°ä»¤ç‰Œ"""
        to_encode = data.copy()
        expire = datetime.utcnow() + timedelta(days=settings.REFRESH_TOKEN_EXPIRE_DAYS)
        to_encode.update({"exp": expire, "type": "refresh"})
        encoded_jwt = jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)
        
        return encoded_jwt
    
    @staticmethod
    def verify_token(token: str, token_type: str = "access") -> TokenData:
        """éªŒè¯ä»¤ç‰Œ"""
        try:
            payload = jwt.decode(token, settings.SECRET_KEY, algorithms=[settings.ALGORITHM])
            
            if payload.get("type") != token_type:
                raise ValueError("Token ç±»å‹ä¸åŒ¹é…")
            
            user_id: int = payload.get("sub")
            username: str = payload.get("username")
            
            if user_id is None:
                raise ValueError("æ— æ•ˆçš„ Token")
            
            return TokenData(user_id=user_id, username=username)
        
        except JWTError:
            raise ValueError("Token éªŒè¯å¤±è´¥")
    
    @staticmethod
    def generate_verification_code(length: int = 6) -> str:
        """ç”ŸæˆéªŒè¯ç """
        return ''.join(secrets.choice(string.digits) for _ in range(length))
    
    @staticmethod
    def create_verification_code(
        db: Session,
        email: Optional[str] = None,
        phone: Optional[str] = None,
        code_type: str = "email_verify"
    ) -> str:
        """åˆ›å»ºå¹¶ä¿å­˜éªŒè¯ç """
        code = AuthService.generate_verification_code()
        
        verification = VerificationCode(
            email=email,
            phone=phone,
            code=code,
            code_type=code_type,
            expires_at=datetime.utcnow() + timedelta(minutes=10)  # 10åˆ†é’Ÿæœ‰æ•ˆæœŸ
        )
        
        db.add(verification)
        db.commit()
        
        return code
    
    @staticmethod
    def verify_code(
        db: Session,
        code: str,
        email: Optional[str] = None,
        phone: Optional[str] = None,
        code_type: str = "email_verify"
    ) -> bool:
        """éªŒè¯éªŒè¯ç """
        query = db.query(VerificationCode).filter(
            VerificationCode.code == code,
            VerificationCode.code_type == code_type,
            VerificationCode.is_used == False,
            VerificationCode.expires_at > datetime.utcnow()
        )
        
        if email:
            query = query.filter(VerificationCode.email == email)
        if phone:
            query = query.filter(VerificationCode.phone == phone)
        
        verification = query.first()
        
        if not verification:
            return False
        
        # æ ‡è®°ä¸ºå·²ä½¿ç”¨
        verification.is_used = True
        db.commit()
        
        return True
    
    @staticmethod
    def check_username_available(db: Session, username: str) -> bool:
        """æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å¯ç”¨"""
        user = db.query(User).filter(User.username == username).first()
        return user is None
    
    @staticmethod
    def check_email_available(db: Session, email: str) -> bool:
        """æ£€æŸ¥é‚®ç®±æ˜¯å¦å¯ç”¨"""
        user = db.query(User).filter(User.email == email).first()
        return user is None
```

#### backend/app/core/security.py

```python
from passlib.context import CryptContext
from jose import JWTError, jwt
from datetime import datetime, timedelta
from typing import Optional
from app.core.config import settings

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def verify_password(plain_password: str, hashed_password: str) -> bool:
    """éªŒè¯å¯†ç """
    return pwd_context.verify(plain_password, hashed_password)

def get_password_hash(password: str) -> str:
    """è·å–å¯†ç å“ˆå¸Œå€¼"""
    return pwd_context.hash(password)

def create_access_token(data: dict, expires_delta: Optional[timedelta] = None) -> str:
    """åˆ›å»ºè®¿é—®ä»¤ç‰Œ"""
    to_encode = data.copy()
    
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
    
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)
    
    return encoded_jwt
```

#### backend/app/api/deps.py

```python
from fastapi import Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer
from jose import JWTError, jwt
from sqlalchemy.orm import Session

from app.db.database import get_db
from app.models.user import User
from app.core.config import settings
from app.schemas.user import TokenData

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/api/auth/login")

async def get_current_user(
    token: str = Depends(oauth2_scheme),
    db: Session = Depends(get_db)
) -> User:
    """è·å–å½“å‰ç™»å½•ç”¨æˆ·"""
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="æ— æ³•éªŒè¯å‡­æ®",
        headers={"WWW-Authenticate": "Bearer"},
    )
    
    try:
        payload = jwt.decode(token, settings.SECRET_KEY, algorithms=[settings.ALGORITHM])
        user_id: int = payload.get("sub")
        
        if user_id is None:
            raise credentials_exception
        
        token_data = TokenData(user_id=user_id)
    
    except JWTError:
        raise credentials_exception
    
    user = db.query(User).filter(User.id == token_data.user_id).first()
    
    if user is None:
        raise credentials_exception
    
    if not user.is_active:
        raise HTTPException(status_code=400, detail="è´¦æˆ·å·²è¢«ç¦ç”¨")
    
    return user

async def get_current_active_user(
    current_user: User = Depends(get_current_user)
) -> User:
    """è·å–å½“å‰æ´»è·ƒç”¨æˆ·"""
    if not current_user.is_active:
        raise HTTPException(status_code=400, detail="è´¦æˆ·æœªæ¿€æ´»")
    return current_user
```

### 4.4 API è·¯ç”±å®ç°

#### backend/app/api/auth.py

```python
from fastapi import APIRouter, Depends, HTTPException, status, BackgroundTasks
from fastapi.security import OAuth2PasswordRequestForm
from sqlalchemy.orm import Session
from datetime import timedelta

from app.db.database import get_db
from app.schemas.user import (
    UserRegister, UserLogin, UserResponse, Token,
    PasswordChange, PasswordReset, SendVerificationCode,
    EmailVerification
)
from app.services.auth import AuthService
from app.api.deps import get_current_user, get_current_active_user
from app.models.user import User
from app.core.config import settings
from app.utils.email import send_verification_email
from app.utils.sms import send_verification_sms

router = APIRouter(prefix="/api/auth", tags=["è®¤è¯"])

@router.post("/register", response_model=UserResponse, status_code=status.HTTP_201_CREATED)
async def register(
    user_data: UserRegister,
    background_tasks: BackgroundTasks,
    db: Session = Depends(get_db)
):
    """
    ç”¨æˆ·æ³¨å†Œ
    
    - **username**: ç”¨æˆ·åï¼ˆ3-50å­—ç¬¦ï¼Œå­—æ¯æ•°å­—ä¸‹åˆ’çº¿ï¼‰
    - **email**: é‚®ç®±åœ°å€
    - **password**: å¯†ç ï¼ˆè‡³å°‘8ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—ï¼‰
    - **phone**: æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰
    - **nickname**: æ˜µç§°ï¼ˆå¯é€‰ï¼‰
    """
    try:
        user = AuthService.create_user(db, user_data)
        
        # å‘é€éªŒè¯é‚®ä»¶ï¼ˆåå°ä»»åŠ¡ï¼‰
        code = AuthService.create_verification_code(
            db, email=user.email, code_type="email_verify"
        )
        background_tasks.add_task(send_verification_email, user.email, code)
        
        return user
    
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))

@router.post("/login", response_model=Token)
async def login(
    form_data: OAuth2PasswordRequestForm = Depends(),
    db: Session = Depends(get_db)
):
    """
    ç”¨æˆ·ç™»å½•
    
    - **username**: ç”¨æˆ·åæˆ–é‚®ç®±
    - **password**: å¯†ç 
    
    è¿”å›è®¿é—®ä»¤ç‰Œå’Œåˆ·æ–°ä»¤ç‰Œ
    """
    try:
        user = AuthService.authenticate_user(
            db, form_data.username, form_data.password
        )
        
        if not user:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯",
                headers={"WWW-Authenticate": "Bearer"},
            )
        
        # åˆ›å»ºè®¿é—®ä»¤ç‰Œ
        access_token = AuthService.create_access_token(
            data={"sub": user.id, "username": user.username}
        )
        
        # åˆ›å»ºåˆ·æ–°ä»¤ç‰Œ
        refresh_token = AuthService.create_refresh_token(
            data={"sub": user.id, "username": user.username}
        )
        
        return {
            "access_token": access_token,
            "refresh_token": refresh_token,
            "token_type": "bearer",
            "expires_in": settings.ACCESS_TOKEN_EXPIRE_MINUTES * 60
        }
    
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))

@router.post("/refresh", response_model=Token)
async def refresh_token(
    refresh_token: str,
    db: Session = Depends(get_db)
):
    """
    åˆ·æ–°è®¿é—®ä»¤ç‰Œ
    
    ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–æ–°çš„è®¿é—®ä»¤ç‰Œ
    """
    try:
        token_data = AuthService.verify_token(refresh_token, token_type="refresh")
        
        # åˆ›å»ºæ–°çš„è®¿é—®ä»¤ç‰Œ
        access_token = AuthService.create_access_token(
            data={"sub": token_data.user_id, "username": token_data.username}
        )
        
        return {
            "access_token": access_token,
            "refresh_token": refresh_token,
            "token_type": "bearer",
            "expires_in": settings.ACCESS_TOKEN_EXPIRE_MINUTES * 60
        }
    
    except ValueError as e:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail=str(e)
        )

@router.post("/logout")
async def logout(current_user: User = Depends(get_current_user)):
    """
    ç”¨æˆ·ç™»å‡º
    
    ï¼ˆå®¢æˆ·ç«¯åˆ é™¤æœ¬åœ° Token å³å¯ï¼‰
    """
    return {"message": "ç™»å‡ºæˆåŠŸ"}

@router.get("/me", response_model=UserResponse)
async def get_me(current_user: User = Depends(get_current_active_user)):
    """è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯"""
    return current_user

@router.post("/send-code")
async def send_verification_code(
    data: SendVerificationCode,
    background_tasks: BackgroundTasks,
    db: Session = Depends(get_db)
):
    """
    å‘é€éªŒè¯ç 
    
    - **email**: é‚®ç®±ï¼ˆé‚®ç®±éªŒè¯æ—¶éœ€è¦ï¼‰
    - **phone**: æ‰‹æœºå·ï¼ˆçŸ­ä¿¡éªŒè¯æ—¶éœ€è¦ï¼‰
    - **code_type**: éªŒè¯ç±»å‹ï¼ˆemail_verify/phone_verify/password_resetï¼‰
    """
    try:
        if data.email:
            code = AuthService.create_verification_code(
                db, email=data.email, code_type=data.code_type
            )
            background_tasks.add_task(send_verification_email, data.email, code)
            return {"message": "éªŒè¯ç å·²å‘é€è‡³é‚®ç®±"}
        
        elif data.phone:
            code = AuthService.create_verification_code(
                db, phone=data.phone, code_type=data.code_type
            )
            background_tasks.add_task(send_verification_sms, data.phone, code)
            return {"message": "éªŒè¯ç å·²å‘é€è‡³æ‰‹æœº"}
        
        else:
            raise HTTPException(status_code=400, detail="è¯·æä¾›é‚®ç®±æˆ–æ‰‹æœºå·")
    
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"å‘é€å¤±è´¥: {str(e)}")

@router.post("/verify-email")
async def verify_email(
    data: EmailVerification,
    db: Session = Depends(get_db)
):
    """éªŒè¯é‚®ç®±"""
    if AuthService.verify_code(db, data.code, email=data.email, code_type="email_verify"):
        # æ›´æ–°ç”¨æˆ·éªŒè¯çŠ¶æ€
        user = db.query(User).filter(User.email == data.email).first()
        if user:
            user.is_verified = True
            db.commit()
        return {"message": "é‚®ç®±éªŒè¯æˆåŠŸ"}
    else:
        raise HTTPException(status_code=400, detail="éªŒè¯ç æ— æ•ˆæˆ–å·²è¿‡æœŸ")

@router.post("/forgot-password")
async def forgot_password(
    email: str,
    background_tasks: BackgroundTasks,
    db: Session = Depends(get_db)
):
    """å¿˜è®°å¯†ç  - å‘é€é‡ç½®éªŒè¯ç """
    user = db.query(User).filter(User.email == email).first()
    
    if not user:
        # ä¸ºäº†å®‰å…¨ï¼Œå³ä½¿ç”¨æˆ·ä¸å­˜åœ¨ä¹Ÿè¿”å›æˆåŠŸ
        return {"message": "å¦‚æœè¯¥é‚®ç®±å·²æ³¨å†Œï¼Œé‡ç½®é“¾æ¥å·²å‘é€"}
    
    code = AuthService.create_verification_code(
        db, email=email, code_type="password_reset"
    )
    background_tasks.add_task(send_verification_email, email, code)
    
    return {"message": "å¦‚æœè¯¥é‚®ç®±å·²æ³¨å†Œï¼Œé‡ç½®é“¾æ¥å·²å‘é€"}

@router.post("/reset-password")
async def reset_password(
    data: PasswordReset,
    db: Session = Depends(get_db)
):
    """é‡ç½®å¯†ç """
    # éªŒè¯éªŒè¯ç 
    if not AuthService.verify_code(db, data.code, email=data.email, code_type="password_reset"):
        raise HTTPException(status_code=400, detail="éªŒè¯ç æ— æ•ˆæˆ–å·²è¿‡æœŸ")
    
    # æ›´æ–°å¯†ç 
    user = db.query(User).filter(User.email == data.email).first()
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ·ä¸å­˜åœ¨")
    
    from app.core.security import get_password_hash
    user.hashed_password = get_password_hash(data.new_password)
    db.commit()
    
    return {"message": "å¯†ç é‡ç½®æˆåŠŸ"}

@router.post("/change-password")
async def change_password(
    data: PasswordChange,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """ä¿®æ”¹å¯†ç ï¼ˆéœ€è¦ç™»å½•ï¼‰"""
    from app.core.security import verify_password, get_password_hash
    
    # éªŒè¯æ—§å¯†ç 
    if not verify_password(data.old_password, current_user.hashed_password):
        raise HTTPException(status_code=400, detail="åŸå¯†ç é”™è¯¯")
    
    # æ›´æ–°å¯†ç 
    current_user.hashed_password = get_password_hash(data.new_password)
    db.commit()
    
    return {"message": "å¯†ç ä¿®æ”¹æˆåŠŸ"}

@router.get("/check-username")
async def check_username(username: str, db: Session = Depends(get_db)):
    """æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å¯ç”¨"""
    available = AuthService.check_username_available(db, username)
    return {"available": available}

@router.get("/check-email")
async def check_email(email: str, db: Session = Depends(get_db)):
    """æ£€æŸ¥é‚®ç®±æ˜¯å¦å¯ç”¨"""
    available = AuthService.check_email_available(db, email)
    return {"available": available}
```

---

## äº”ã€å‰ç«¯å®ç°

### 5.1 API æœåŠ¡å°è£…

#### mobile/src/services/authService.ts

```typescript
import apiClient from './api';
import AsyncStorage from '@react-native-async-storage/async-storage';

export interface RegisterData {
  username: string;
  email: string;
  password: string;
  phone?: string;
  nickname?: string;
}

export interface LoginData {
  username: string;
  password: string;
}

export interface TokenResponse {
  access_token: string;
  refresh_token: string;
  token_type: string;
  expires_in: number;
}

export interface UserProfile {
  id: number;
  username: string;
  email: string;
  nickname?: string;
  avatar?: string;
  bio?: string;
  skill_level: string;
  is_verified: boolean;
  is_premium: boolean;
  created_at: string;
}

export const authService = {
  /**
   * ç”¨æˆ·æ³¨å†Œ
   */
  async register(data: RegisterData): Promise<UserProfile> {
    const response = await apiClient.post('/api/auth/register', data);
    return response.data;
  },

  /**
   * ç”¨æˆ·ç™»å½•
   */
  async login(data: LoginData): Promise<TokenResponse> {
    const formData = new FormData();
    formData.append('username', data.username);
    formData.append('password', data.password);

    const response = await apiClient.post('/api/auth/login', formData, {
      headers: {
        'Content-Type': 'multipart/form-data',
      },
    });

    const tokens = response.data;

    // ä¿å­˜ Token
    await AsyncStorage.setItem('access_token', tokens.access_token);
    await AsyncStorage.setItem('refresh_token', tokens.refresh_token);

    return tokens;
  },

  /**
   * åˆ·æ–° Token
   */
  async refreshToken(): Promise<TokenResponse> {
    const refreshToken = await AsyncStorage.getItem('refresh_token');

    if (!refreshToken) {
      throw new Error('No refresh token available');
    }

    const response = await apiClient.post('/api/auth/refresh', {
      refresh_token: refreshToken,
    });

    const tokens = response.data;

    // æ›´æ–° Token
    await AsyncStorage.setItem('access_token', tokens.access_token);

    return tokens;
  },

  /**
   * ç”¨æˆ·ç™»å‡º
   */
  async logout(): Promise<void> {
    try {
      await apiClient.post('/api/auth/logout');
    } finally {
      // æ¸…é™¤æœ¬åœ° Token
      await AsyncStorage.removeItem('access_token');
      await AsyncStorage.removeItem('refresh_token');
    }
  },

  /**
   * è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
   */
  async getCurrentUser(): Promise<UserProfile> {
    const response = await apiClient.get('/api/auth/me');
    return response.data;
  },

  /**
   * å‘é€éªŒè¯ç 
   */
  async sendVerificationCode(
    email?: string,
    phone?: string,
    codeType: string = 'email_verify'
  ): Promise<{ message: string }> {
    const response = await apiClient.post('/api/auth/send-code', {
      email,
      phone,
      code_type: codeType,
    });
    return response.data;
  },

  /**
   * éªŒè¯é‚®ç®±
   */
  async verifyEmail(email: string, code: string): Promise<{ message: string }> {
    const response = await apiClient.post('/api/auth/verify-email', {
      email,
      code,
    });
    return response.data;
  },

  /**
   * å¿˜è®°å¯†ç 
   */
  async forgotPassword(email: string): Promise<{ message: string }> {
    const response = await apiClient.post('/api/auth/forgot-password', {
      email,
    });
    return response.data;
  },

  /**
   * é‡ç½®å¯†ç 
   */
  async resetPassword(
    email: string,
    code: string,
    newPassword: string
  ): Promise<{ message: string }> {
    const response = await apiClient.post('/api/auth/reset-password', {
      email,
      code,
      new_password: newPassword,
    });
    return response.data;
  },

  /**
   * ä¿®æ”¹å¯†ç 
   */
  async changePassword(
    oldPassword: string,
    newPassword: string
  ): Promise<{ message: string }> {
    const response = await apiClient.post('/api/auth/change-password', {
      old_password: oldPassword,
      new_password: newPassword,
    });
    return response.data;
  },

  /**
   * æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å¯ç”¨
   */
  async checkUsername(username: string): Promise<boolean> {
    const response = await apiClient.get('/api/auth/check-username', {
      params: { username },
    });
    return response.data.available;
  },

  /**
   * æ£€æŸ¥é‚®ç®±æ˜¯å¦å¯ç”¨
   */
  async checkEmail(email: string): Promise<boolean> {
    const response = await apiClient.get('/api/auth/check-email', {
      params: { email },
    });
    return response.data.available;
  },

  /**
   * æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
   */
  async isAuthenticated(): Promise<boolean> {
    const token = await AsyncStorage.getItem('access_token');
    return !!token;
  },
};
```

### 5.2 ç™»å½•é¡µé¢å®ç°

#### mobile/src/screens/auth/LoginScreen.tsx

```typescript
import React, { useState } from 'react';
import {
  View,
  Text,
  TextInput,
  TouchableOpacity,
  StyleSheet,
  Alert,
  ActivityIndicator,
  KeyboardAvoidingView,
  Platform,
} from 'react-native';
import { useNavigation } from '@react-navigation/native';
import { authService } from '../../services/authService';
import { colors, typography, spacing } from '../../design-tokens';

/**
 * ç™»å½•é¡µé¢
 * @figma 03-01-login-blank, 03-02-login-filled-pass-hide
 */
const LoginScreen = () => {
  const navigation = useNavigation();
  
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [passwordVisible, setPasswordVisible] = useState(false);
  const [loading, setLoading] = useState(false);

  const handleLogin = async () => {
    if (!username || !password) {
      Alert.alert('æç¤º', 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
      return;
    }

    setLoading(true);

    try {
      await authService.login({ username, password });
      
      // ç™»å½•æˆåŠŸï¼Œå¯¼èˆªåˆ°ä¸»é¡µ
      navigation.reset({
        index: 0,
        routes: [{ name: 'Main' }],
      });
    } catch (error: any) {
      Alert.alert(
        'ç™»å½•å¤±è´¥',
        error.response?.data?.detail || 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
      );
    } finally {
      setLoading(false);
    }
  };

  return (
    <KeyboardAvoidingView
      style={styles.container}
      behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
    >
      <View style={styles.content}>
        {/* Logo */}
        <View style={styles.logoContainer}>
          <Text style={styles.logo}>ğŸ¾</Text>
          <Text style={styles.appName}>Tennis Social</Text>
        </View>

        {/* è¡¨å• */}
        <View style={styles.form}>
          <Text style={styles.title}>ç™»å½•</Text>

          <TextInput
            style={styles.input}
            placeholder="ç”¨æˆ·åæˆ–é‚®ç®±"
            value={username}
            onChangeText={setUsername}
            autoCapitalize="none"
            autoCorrect={false}
          />

          <View style={styles.passwordContainer}>
            <TextInput
              style={styles.passwordInput}
              placeholder="å¯†ç "
              value={password}
              onChangeText={setPassword}
              secureTextEntry={!passwordVisible}
              autoCapitalize="none"
            />
            <TouchableOpacity
              style={styles.eyeIcon}
              onPress={() => setPasswordVisible(!passwordVisible)}
            >
              <Text>{passwordVisible ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}</Text>
            </TouchableOpacity>
          </View>

          <TouchableOpacity
            style={styles.forgotPassword}
            onPress={() => navigation.navigate('ForgotPassword')}
          >
            <Text style={styles.forgotPasswordText}>å¿˜è®°å¯†ç ï¼Ÿ</Text>
          </TouchableOpacity>

          <TouchableOpacity
            style={styles.loginButton}
            onPress={handleLogin}
            disabled={loading}
          >
            {loading ? (
              <ActivityIndicator color="#fff" />
            ) : (
              <Text style={styles.loginButtonText}>ç™»å½•</Text>
            )}
          </TouchableOpacity>

          <View style={styles.footer}>
            <Text style={styles.footerText}>è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ </Text>
            <TouchableOpacity onPress={() => navigation.navigate('Register')}>
              <Text style={styles.signupLink}>ç«‹å³æ³¨å†Œ</Text>
            </TouchableOpacity>
          </View>
        </View>
      </View>
    </KeyboardAvoidingView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: colors.background.main,
  },
  content: {
    flex: 1,
    padding: spacing.lg,
    justifyContent: 'center',
  },
  logoContainer: {
    alignItems: 'center',
    marginBottom: spacing.xxl,
  },
  logo: {
    fontSize: 80,
  },
  appName: {
    fontSize: typography.h1.fontSize,
    fontWeight: typography.h1.fontWeight as any,
    color: colors.primary.main,
    marginTop: spacing.md,
  },
  form: {
    width: '100%',
  },
  title: {
    fontSize: typography.h2.fontSize,
    fontWeight: typography.h2.fontWeight as any,
    color: colors.text.primary,
    marginBottom: spacing.lg,
  },
  input: {
    height: 50,
    borderWidth: 1,
    borderColor: colors.gray.light,
    borderRadius: 8,
    paddingHorizontal: spacing.md,
    marginBottom: spacing.md,
    fontSize: typography.body.fontSize,
  },
  passwordContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    height: 50,
    borderWidth: 1,
    borderColor: colors.gray.light,
    borderRadius: 8,
    marginBottom: spacing.sm,
  },
  passwordInput: {
    flex: 1,
    paddingHorizontal: spacing.md,
    fontSize: typography.body.fontSize,
  },
  eyeIcon: {
    padding: spacing.md,
  },
  forgotPassword: {
    alignSelf: 'flex-end',
    marginBottom: spacing.lg,
  },
  forgotPasswordText: {
    color: colors.primary.main,
    fontSize: typography.bodySmall.fontSize,
  },
  loginButton: {
    height: 50,
    backgroundColor: colors.primary.main,
    borderRadius: 8,
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: spacing.lg,
  },
  loginButtonText: {
    color: colors.text.white,
    fontSize: typography.button.fontSize,
    fontWeight: typography.button.fontWeight as any,
  },
  footer: {
    flexDirection: 'row',
    justifyContent: 'center',
    marginTop: spacing.md,
  },
  footerText: {
    color: colors.text.secondary,
    fontSize: typography.body.fontSize,
  },
  signupLink: {
    color: colors.primary.main,
    fontSize: typography.body.fontSize,
    fontWeight: '600',
  },
});

export default LoginScreen;
```

### 5.3 æ³¨å†Œé¡µé¢å®ç°

#### mobile/src/screens/auth/RegisterScreen.tsx

```typescript
import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  TextInput,
  TouchableOpacity,
  StyleSheet,
  Alert,
  ActivityIndicator,
  KeyboardAvoidingView,
  Platform,
  ScrollView,
} from 'react-native';
import { useNavigation } from '@react-navigation/native';
import { authService } from '../../services/authService';
import { colors, typography, spacing } from '../../design-tokens';

/**
 * æ³¨å†Œé¡µé¢
 * @figma 05-01-signup-blank, 05-02-signup-filled-pass-strong
 */
const RegisterScreen = () => {
  const navigation = useNavigation();
  
  const [username, setUsername] = useState('');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [passwordVisible, setPasswordVisible] = useState(false);
  const [loading, setLoading] = useState(false);
  
  const [passwordStrength, setPasswordStrength] = useState<'weak' | 'medium' | 'strong'>('weak');
  const [usernameAvailable, setUsernameAvailable] = useState<boolean | null>(null);

  // æ£€æŸ¥ç”¨æˆ·åå¯ç”¨æ€§
  useEffect(() => {
    if (username.length >= 3) {
      const timer = setTimeout(async () => {
        const available = await authService.checkUsername(username);
        setUsernameAvailable(available);
      }, 500);
      return () => clearTimeout(timer);
    } else {
      setUsernameAvailable(null);
    }
  }, [username]);

  // æ£€æŸ¥å¯†ç å¼ºåº¦
  useEffect(() => {
    if (password.length === 0) {
      setPasswordStrength('weak');
      return;
    }

    let strength = 0;
    if (password.length >= 8) strength++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;
    if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength++;

    if (strength <= 1) setPasswordStrength('weak');
    else if (strength <= 2) setPasswordStrength('medium');
    else setPasswordStrength('strong');
  }, [password]);

  const validateForm = (): boolean => {
    if (!username || username.length < 3) {
      Alert.alert('æç¤º', 'ç”¨æˆ·åè‡³å°‘ 3 ä¸ªå­—ç¬¦');
      return false;
    }

    if (!usernameAvailable) {
      Alert.alert('æç¤º', 'ç”¨æˆ·åå·²è¢«ä½¿ç”¨');
      return false;
    }

    if (!email || !email.includes('@')) {
      Alert.alert('æç¤º', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
      return false;
    }

    if (password.length < 8) {
      Alert.alert('æç¤º', 'å¯†ç è‡³å°‘ 8 ä¸ªå­—ç¬¦');
      return false;
    }

    if (!/\d/.test(password) || !/[a-zA-Z]/.test(password)) {
      Alert.alert('æç¤º', 'å¯†ç å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—');
      return false;
    }

    if (password !== confirmPassword) {
      Alert.alert('æç¤º', 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
      return false;
    }

    return true;
  };

  const handleRegister = async () => {
    if (!validateForm()) {
      return;
    }

    setLoading(true);

    try {
      await authService.register({
        username,
        email,
        password,
      });

      Alert.alert(
        'æ³¨å†ŒæˆåŠŸ',
        'éªŒè¯é‚®ä»¶å·²å‘é€ï¼Œè¯·æŸ¥æ”¶é‚®ä»¶å¹¶éªŒè¯',
        [
          {
            text: 'ç¡®å®š',
            onPress: () => navigation.navigate('Login'),
          },
        ]
      );
    } catch (error: any) {
      Alert.alert(
        'æ³¨å†Œå¤±è´¥',
        error.response?.data?.detail || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•'
      );
    } finally {
      setLoading(false);
    }
  };

  const getPasswordStrengthColor = () => {
    switch (passwordStrength) {
      case 'weak':
        return colors.status.error;
      case 'medium':
        return colors.status.warning;
      case 'strong':
        return colors.status.success;
    }
  };

  const getPasswordStrengthText = () => {
    switch (passwordStrength) {
      case 'weak':
        return 'å¼±';
      case 'medium':
        return 'ä¸­';
      case 'strong':
        return 'å¼º';
    }
  };

  return (
    <KeyboardAvoidingView
      style={styles.container}
      behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
    >
      <ScrollView contentContainerStyle={styles.scrollContent}>
        <View style={styles.content}>
          <Text style={styles.title}>åˆ›å»ºè´¦å·</Text>
          <Text style={styles.subtitle}>åŠ å…¥ç½‘çƒç¤¾äº¤å¹³å°</Text>

          {/* ç”¨æˆ·å */}
          <View style={styles.inputContainer}>
            <TextInput
              style={styles.input}
              placeholder="ç”¨æˆ·å"
              value={username}
              onChangeText={setUsername}
              autoCapitalize="none"
              autoCorrect={false}
            />
            {username.length >= 3 && (
              <Text
                style={[
                  styles.hint,
                  { color: usernameAvailable ? colors.status.success : colors.status.error },
                ]}
              >
                {usernameAvailable ? 'âœ“ å¯ç”¨' : 'âœ— å·²è¢«ä½¿ç”¨'}
              </Text>
            )}
          </View>

          {/* é‚®ç®± */}
          <TextInput
            style={styles.input}
            placeholder="é‚®ç®±"
            value={email}
            onChangeText={setEmail}
            keyboardType="email-address"
            autoCapitalize="none"
            autoCorrect={false}
          />

          {/* å¯†ç  */}
          <View style={styles.inputContainer}>
            <View style={styles.passwordContainer}>
              <TextInput
                style={styles.passwordInput}
                placeholder="å¯†ç ï¼ˆè‡³å°‘8ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—ï¼‰"
                value={password}
                onChangeText={setPassword}
                secureTextEntry={!passwordVisible}
                autoCapitalize="none"
              />
              <TouchableOpacity
                style={styles.eyeIcon}
                onPress={() => setPasswordVisible(!passwordVisible)}
              >
                <Text>{passwordVisible ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}</Text>
              </TouchableOpacity>
            </View>
            {password.length > 0 && (
              <View style={styles.strengthContainer}>
                <Text style={styles.strengthLabel}>å¯†ç å¼ºåº¦ï¼š</Text>
                <Text style={[styles.strengthText, { color: getPasswordStrengthColor() }]}>
                  {getPasswordStrengthText()}
                </Text>
              </View>
            )}
          </View>

          {/* ç¡®è®¤å¯†ç  */}
          <TextInput
            style={styles.input}
            placeholder="ç¡®è®¤å¯†ç "
            value={confirmPassword}
            onChangeText={setConfirmPassword}
            secureTextEntry={!passwordVisible}
            autoCapitalize="none"
          />

          {/* æ³¨å†ŒæŒ‰é’® */}
          <TouchableOpacity
            style={styles.registerButton}
            onPress={handleRegister}
            disabled={loading}
          >
            {loading ? (
              <ActivityIndicator color="#fff" />
            ) : (
              <Text style={styles.registerButtonText}>æ³¨å†Œ</Text>
            )}
          </TouchableOpacity>

          {/* å·²æœ‰è´¦å· */}
          <View style={styles.footer}>
            <Text style={styles.footerText}>å·²æœ‰è´¦å·ï¼Ÿ </Text>
            <TouchableOpacity onPress={() => navigation.navigate('Login')}>
              <Text style={styles.loginLink}>ç«‹å³ç™»å½•</Text>
            </TouchableOpacity>
          </View>
        </View>
      </ScrollView>
    </KeyboardAvoidingView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: colors.background.main,
  },
  scrollContent: {
    flexGrow: 1,
  },
  content: {
    flex: 1,
    padding: spacing.lg,
    justifyContent: 'center',
  },
  title: {
    fontSize: typography.h1.fontSize,
    fontWeight: typography.h1.fontWeight as any,
    color: colors.text.primary,
    marginBottom: spacing.sm,
  },
  subtitle: {
    fontSize: typography.body.fontSize,
    color: colors.text.secondary,
    marginBottom: spacing.xl,
  },
  inputContainer: {
    marginBottom: spacing.md,
  },
  input: {
    height: 50,
    borderWidth: 1,
    borderColor: colors.gray.light,
    borderRadius: 8,
    paddingHorizontal: spacing.md,
    marginBottom: spacing.md,
    fontSize: typography.body.fontSize,
  },
  passwordContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    height: 50,
    borderWidth: 1,
    borderColor: colors.gray.light,
    borderRadius: 8,
  },
  passwordInput: {
    flex: 1,
    paddingHorizontal: spacing.md,
    fontSize: typography.body.fontSize,
  },
  eyeIcon: {
    padding: spacing.md,
  },
  hint: {
    fontSize: typography.caption.fontSize,
    marginTop: -spacing.sm,
    marginBottom: spacing.sm,
  },
  strengthContainer: {
    flexDirection: 'row',
    marginTop: spacing.xs,
  },
  strengthLabel: {
    fontSize: typography.caption.fontSize,
    color: colors.text.secondary,
  },
  strengthText: {
    fontSize: typography.caption.fontSize,
    fontWeight: '600',
  },
  registerButton: {
    height: 50,
    backgroundColor: colors.primary.main,
    borderRadius: 8,
    justifyContent: 'center',
    alignItems: 'center',
    marginTop: spacing.lg,
    marginBottom: spacing.lg,
  },
  registerButtonText: {
    color: colors.text.white,
    fontSize: typography.button.fontSize,
    fontWeight: typography.button.fontWeight as any,
  },
  footer: {
    flexDirection: 'row',
    justifyContent: 'center',
    marginTop: spacing.md,
  },
  footerText: {
    color: colors.text.secondary,
    fontSize: typography.body.fontSize,
  },
  loginLink: {
    color: colors.primary.main,
    fontSize: typography.body.fontSize,
    fontWeight: '600',
  },
});

export default RegisterScreen;
```

---

## å…­ã€å®‰å…¨æœ€ä½³å®è·µ

### 6.1 å¯†ç å®‰å…¨
- âœ… ä½¿ç”¨ Bcrypt åŠ å¯†å­˜å‚¨å¯†ç 
- âœ… å¼ºåˆ¶å¯†ç å¼ºåº¦è¦æ±‚ï¼ˆæœ€å°‘8ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—ï¼‰
- âœ… å¯†ç ä¸åœ¨æ—¥å¿—æˆ–é”™è¯¯ä¿¡æ¯ä¸­æ˜¾ç¤º
- âœ… æ”¯æŒå¯†ç é‡ç½®åŠŸèƒ½

### 6.2 Token å®‰å…¨
- âœ… JWT Token è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆAccess: 30åˆ†é’Ÿï¼ŒRefresh: 7å¤©ï¼‰
- âœ… ä½¿ç”¨ HTTPS ä¼ è¾“ Token
- âœ… æ•æ„Ÿæ“ä½œéœ€è¦é‡æ–°éªŒè¯
- âœ… æ”¯æŒ Token æ’¤é”€ï¼ˆåˆ·æ–°ä»¤ç‰Œè¡¨ï¼‰

### 6.3 éªŒè¯ç å®‰å…¨
- âœ… éªŒè¯ç  10 åˆ†é’Ÿæœ‰æ•ˆæœŸ
- âœ… éªŒè¯ç ä¸€æ¬¡æ€§ä½¿ç”¨
- âœ… é™åˆ¶éªŒè¯ç å‘é€é¢‘ç‡ï¼ˆé˜²æ­¢æš´åŠ›ç ´è§£ï¼‰
- âœ… éªŒè¯ç  6 ä½éšæœºæ•°å­—

### 6.4 API å®‰å…¨
- âœ… æ‰€æœ‰æ•æ„Ÿæ¥å£éœ€è¦è®¤è¯
- âœ… ä½¿ç”¨ CORS é™åˆ¶è·¨åŸŸè®¿é—®
- âœ… å®ç°è¯·æ±‚é€Ÿç‡é™åˆ¶
- âœ… è¾“å…¥éªŒè¯å’Œæ¸…ç†

### 6.5 æ•°æ®å®‰å…¨
- âœ… æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
- âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢ SQL æ³¨å…¥
- âœ… å®šæœŸå¤‡ä»½æ•°æ®åº“
- âœ… è®°å½•ç™»å½•æ—¥å¿—

---

## ä¸ƒã€æµ‹è¯•è®¡åˆ’

### 7.1 å•å…ƒæµ‹è¯•

```python
# tests/test_auth.py

import pytest
from app.services.auth import AuthService
from app.schemas.user import UserRegister

def test_create_user(db_session):
    """æµ‹è¯•ç”¨æˆ·åˆ›å»º"""
    user_data = UserRegister(
        username="testuser",
        email="test@example.com",
        password="Test1234"
    )
    
    user = AuthService.create_user(db_session, user_data)
    
    assert user.username == "testuser"
    assert user.email == "test@example.com"
    assert user.hashed_password != "Test1234"

def test_authenticate_user(db_session, test_user):
    """æµ‹è¯•ç”¨æˆ·è®¤è¯"""
    user = AuthService.authenticate_user(
        db_session,
        "testuser",
        "Test1234"
    )
    
    assert user is not None
    assert user.username == "testuser"

def test_authenticate_user_wrong_password(db_session, test_user):
    """æµ‹è¯•é”™è¯¯å¯†ç """
    user = AuthService.authenticate_user(
        db_session,
        "testuser",
        "wrongpassword"
    )
    
    assert user is None
```

### 7.2 é›†æˆæµ‹è¯•

```python
# tests/test_api_auth.py

from fastapi.testclient import TestClient

def test_register(client: TestClient):
    """æµ‹è¯•æ³¨å†Œ API"""
    response = client.post("/api/auth/register", json={
        "username": "newuser",
        "email": "newuser@example.com",
        "password": "Test1234"
    })
    
    assert response.status_code == 201
    assert response.json()["username"] == "newuser"

def test_login(client: TestClient, test_user):
    """æµ‹è¯•ç™»å½• API"""
    response = client.post("/api/auth/login", data={
        "username": "testuser",
        "password": "Test1234"
    })
    
    assert response.status_code == 200
    assert "access_token" in response.json()
    assert "refresh_token" in response.json()

def test_get_current_user(client: TestClient, auth_headers):
    """æµ‹è¯•è·å–å½“å‰ç”¨æˆ·"""
    response = client.get("/api/auth/me", headers=auth_headers)
    
    assert response.status_code == 200
    assert "username" in response.json()
```

### 7.3 å‰ç«¯æµ‹è¯•

```typescript
// __tests__/LoginScreen.test.tsx

import React from 'react';
import { render, fireEvent, waitFor } from '@testing-library/react-native';
import LoginScreen from '../src/screens/auth/LoginScreen';
import { authService } from '../src/services/authService';

jest.mock('../src/services/authService');

describe('LoginScreen', () => {
  it('æ¸²æŸ“ç™»å½•è¡¨å•', () => {
    const { getByPlaceholderText, getByText } = render(<LoginScreen />);
    
    expect(getByPlaceholderText('ç”¨æˆ·åæˆ–é‚®ç®±')).toBeTruthy();
    expect(getByPlaceholderText('å¯†ç ')).toBeTruthy();
    expect(getByText('ç™»å½•')).toBeTruthy();
  });

  it('æˆåŠŸç™»å½•', async () => {
    const mockLogin = authService.login as jest.Mock;
    mockLogin.mockResolvedValue({
      access_token: 'test_token',
      refresh_token: 'test_refresh',
      token_type: 'bearer',
      expires_in: 1800,
    });

    const { getByPlaceholderText, getByText } = render(<LoginScreen />);
    
    fireEvent.changeText(getByPlaceholderText('ç”¨æˆ·åæˆ–é‚®ç®±'), 'testuser');
    fireEvent.changeText(getByPlaceholderText('å¯†ç '), 'Test1234');
    fireEvent.press(getByText('ç™»å½•'));

    await waitFor(() => {
      expect(mockLogin).toHaveBeenCalledWith({
        username: 'testuser',
        password: 'Test1234',
      });
    });
  });
});
```

---

## å…«ã€éƒ¨ç½²é…ç½®

### 8.1 ç¯å¢ƒå˜é‡é…ç½®

**backend/.env**
```env
# æ•°æ®åº“
DATABASE_URL=postgresql://user:password@localhost:5432/tennis_db

# JWT é…ç½®
SECRET_KEY=your-super-secret-key-change-this-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7

# é‚®ä»¶é…ç½®
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-email-password
SMTP_FROM=noreply@tennisapp.com

# çŸ­ä¿¡é…ç½®ï¼ˆé˜¿é‡Œäº‘ï¼‰
ALIYUN_SMS_ACCESS_KEY_ID=your-access-key-id
ALIYUN_SMS_ACCESS_KEY_SECRET=your-access-key-secret
ALIYUN_SMS_SIGN_NAME=ç½‘çƒç¤¾äº¤
ALIYUN_SMS_TEMPLATE_CODE=SMS_123456789

# åº”ç”¨é…ç½®
DEBUG=False
CORS_ORIGINS=["https://yourdomain.com"]
```

### 8.2 æ•°æ®åº“è¿ç§»

```bash
# åˆ›å»ºè¿ç§»
alembic revision --autogenerate -m "åˆ›å»ºç”¨æˆ·è®¤è¯è¡¨"

# æ‰§è¡Œè¿ç§»
alembic upgrade head

# å›æ»š
alembic downgrade -1
```

---

## ä¹ã€å¼€å‘è®¡åˆ’

### ç¬¬1å‘¨ï¼šåç«¯åŸºç¡€ï¼ˆ5å¤©ï¼‰
- âœ… Day 1-2: æ•°æ®åº“è®¾è®¡å’Œæ¨¡å‹åˆ›å»º
- âœ… Day 3-4: è®¤è¯æœåŠ¡å’Œ API å®ç°
- âœ… Day 5: å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

### ç¬¬2å‘¨ï¼šå‰ç«¯å®ç°ï¼ˆ5å¤©ï¼‰
- âœ… Day 1-2: ç™»å½•é¡µé¢
- âœ… Day 3-4: æ³¨å†Œé¡µé¢
- âœ… Day 5: å¿˜è®°å¯†ç æµç¨‹

### ç¬¬3å‘¨ï¼šå®Œå–„å’Œæµ‹è¯•ï¼ˆ5å¤©ï¼‰
- âœ… Day 1-2: é‚®ç®±éªŒè¯å’ŒçŸ­ä¿¡éªŒè¯
- âœ… Day 3: Token åˆ·æ–°æœºåˆ¶
- âœ… Day 4: å®‰å…¨æ€§åŠ å›º
- âœ… Day 5: ç«¯åˆ°ç«¯æµ‹è¯•

---

## åã€API æ–‡æ¡£

åç«¯å¯åŠ¨åï¼Œå¯ä»¥è®¿é—®è‡ªåŠ¨ç”Ÿæˆçš„ API æ–‡æ¡£ï¼š

- **Swagger UI:** `http://localhost:8000/docs`
- **ReDoc:** `http://localhost:8000/redoc`

---

## é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

#### åç«¯æ–‡ä»¶
```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ auth.py              âœ… è®¤è¯ API è·¯ç”±
â”‚   â”‚   â””â”€â”€ deps.py              âœ… ä¾èµ–æ³¨å…¥
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ user.py              âœ… ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ verification_code.py âœ… éªŒè¯ç æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ login_log.py         âœ… ç™»å½•æ—¥å¿—æ¨¡å‹
â”‚   â”‚   â””â”€â”€ refresh_token.py     âœ… åˆ·æ–°ä»¤ç‰Œæ¨¡å‹
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â””â”€â”€ user.py              âœ… ç”¨æˆ·æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ auth.py              âœ… è®¤è¯ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ config.py            âœ… é…ç½®æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ security.py          âœ… å®‰å…¨å·¥å…·
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ email.py             âœ… é‚®ä»¶å‘é€
â”‚       â””â”€â”€ sms.py               âœ… çŸ­ä¿¡å‘é€
```

#### å‰ç«¯æ–‡ä»¶
```
mobile/src/
â”œâ”€â”€ screens/
â”‚   â””â”€â”€ auth/
â”‚       â”œâ”€â”€ LoginScreen.tsx      âœ… ç™»å½•é¡µé¢
â”‚       â”œâ”€â”€ RegisterScreen.tsx   âœ… æ³¨å†Œé¡µé¢
â”‚       â”œâ”€â”€ ForgotPasswordScreen.tsx âœ… å¿˜è®°å¯†ç 
â”‚       â””â”€â”€ ResetPasswordScreen.tsx  âœ… é‡ç½®å¯†ç 
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ api.ts                   âœ… API å®¢æˆ·ç«¯
â”‚   â””â”€â”€ authService.ts           âœ… è®¤è¯æœåŠ¡
â””â”€â”€ design-tokens/
    â”œâ”€â”€ colors.ts                âœ… é¢œè‰²è§„èŒƒ
    â”œâ”€â”€ typography.ts            âœ… å­—ä½“è§„èŒƒ
    â””â”€â”€ spacing.ts               âœ… é—´è·è§„èŒƒ
```

### B. è®¾è®¡ç¨¿å¯¹ç…§

| åŠŸèƒ½ | Figma é¡µé¢ | ä»£ç æ–‡ä»¶ |
|------|-----------|---------|
| å¯åŠ¨é¡µ | 01-07-splash-screen | SplashScreen.tsx |
| ç™»å½•ï¼ˆç©ºç™½ï¼‰ | 03-01-login-blank | LoginScreen.tsx |
| ç™»å½•ï¼ˆå·²å¡«å†™ï¼‰ | 03-02-login-filled-pass-hide | LoginScreen.tsx |
| ç™»å½•ï¼ˆå¯†ç æ˜¾ç¤ºï¼‰ | 03-03-login-filled-pass-unhide | LoginScreen.tsx |
| ç™»å½•æˆåŠŸ | 03-04-login-success-loading-circle | LoginScreen.tsx |
| å¿˜è®°å¯†ç  | 04-01-forgot-password-email-blank | ForgotPasswordScreen.tsx |
| éªŒè¯ç  | 04-03-code-verification | VerificationScreen.tsx |
| é‡ç½®å¯†ç  | 04-04-reset-password-blank | ResetPasswordScreen.tsx |
| æ³¨å†Œï¼ˆç©ºç™½ï¼‰ | 05-01-signup-blank | RegisterScreen.tsx |
| æ³¨å†Œï¼ˆå¼ºå¯†ç ï¼‰ | 05-02-signup-filled-pass-strong | RegisterScreen.tsx |
| æ³¨å†Œï¼ˆå¼±å¯†ç ï¼‰ | 05-03-signup-filled-pass-weak | RegisterScreen.tsx |
| æ³¨å†ŒæˆåŠŸ | 05-05-signup-success-loading-circle | RegisterScreen.tsx |

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**åˆ›å»ºæ—¥æœŸï¼š** 2025-11-03  
**æœ€åæ›´æ–°ï¼š** 2025-11-03

**ä¸‹ä¸€æ­¥ï¼š** å¼€å§‹å®ç°ç”¨æˆ·ç™»å½•ç³»ç»Ÿï¼ğŸš€

